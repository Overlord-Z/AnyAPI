<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AnyAPI - Modern PowerShell REST API Manager">
    <title>AnyAPI - PowerShell REST API Manager</title>
    
    <!-- Modern Font Stack -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons for Professional Look -->
    <script src="https://unpkg.com/feather-icons"></script>
      <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/profile-edit-modal.css">
    <link rel="stylesheet" href="css/endpoint-tester.css">
    <link rel="stylesheet" href="css/response-explorer.css">
    <link rel="stylesheet" href="css/template-manager.css">
    <style>
        /* Connected status glow */
        .connection-status.connected {
            color: #27d645;
            text-shadow: 0 0 8px #27d645, 0 0 2px #27d645;
            font-weight: 600;
            letter-spacing: 0.03em;
            transition: color 0.2s, text-shadow 0.2s;
        }
        /* Toast notifications bottom-left, compact */
        .notifications {
            position: fixed;
            left: 16px;
            bottom: 16px;
            z-index: 9999;
            display: flex;
            flex-direction: column-reverse;
            align-items: flex-start;
            gap: 0.5em;
            pointer-events: none;
            width: fit-content;
            min-width: 220px;
            max-width: 400px;
        }
        .notification {
            min-width: 180px;
            max-width: 320px;
            background: var(--bg-secondary, #23272e);
            color: var(--text-default, #fff);
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            padding: 0.5em 1em;
            margin: 0;
            font-size: 0.98em;
            line-height: 1.4;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
        .notification.success { border-left: 4px solid #27d645; }
        .notification.error { border-left: 4px solid #e74c3c; }
        .notification.info { border-left: 4px solid #3498db; }
        .notification.warning { border-left: 4px solid #f1c40f; }

        /* Profile selector styles */
        .global-profile-selector {
            display: inline-flex;
            align-items: center;
            margin-left: 1em;
            position: relative;
        }
        .profile-selector-label {
            margin-right: 0.25em;
            font-weight: 375;
            color: var(--purple-primary-dark, #888);
            vertical-align: middle;
        }
        .profile-selector-dropdown {
            min-width: 180px;
            padding: 0.4em 0.8em;
            border: 1px solid var(--border-color, #444);
            border-radius: 4px;
            background: var(--bg-secondary, #23272e);
            color: var(--text-default, #fff);
            appearance: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .profile-selector-dropdown:focus {
            outline: none;
            border-color: var(--purple-primary);
        }

        /* Connection status styles */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5em;
            font-weight: 500;
            color: var(--text-default, #fff);
        }
        .connection-status i {
            width: 16px;
            height: 16px;
        }
        .connection-status.connected {
            color: #27d645;
        }
        .connection-status.disconnected {
            color: #e74c3c;
        }
        .connection-status.connecting {
            color: #f1c40f;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <h3>Loading AnyAPI</h3>
            <p>Initializing your modern API management interface...</p>
        </div>
    </div>

    <!-- Secret Store Password Modal -->
    <div id="secret-password-modal" class="modal" style="z-index: 99999 !important;">
        <div class="modal-content" style="z-index: 100000 !important; position: relative;">
            <div class="modal-header">
                <h3>SecretStore Password</h3>
                <button class="modal-close" onclick="secretManager.closePasswordModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Enter your SecretStore password to unlock secure credential storage:</p>
                <form id="secret-store-form" onsubmit="event.preventDefault(); secretManager.unlockSecretStore();">
                    <input type="password" id="secret-store-password" class="form-control" placeholder="SecretStore Password" autocomplete="new-password">
                </form>
                <div class="form-note">
                    <i data-feather="info"></i>
                    Your credentials will be encrypted and stored securely
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="secretManager.skipSecretStore()">Skip</button>
                <button type="submit" form="secret-store-form" class="btn btn-primary">
                    <i data-feather="unlock"></i>
                    Unlock
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Modern Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <button class="sidebar-toggle" onclick="toggleSidebarGlobal()" title="Toggle Sidebar">
                        <i data-feather="menu"></i>
                    </button>
                    <div class="app-logo" style="display: inline-flex; align-items: center;">
                        <i data-feather="zap"></i>
                        <span class="app-title" style="margin-right: 1em;">AnyAPI</span>
                        <!-- Move global profile selector here, next to logo -->
                        <div class="global-profile-selector">
                            <span class="profile-selector-label">Active Profile:</span>
                            <select id="global-profile-selector" class="profile-selector-dropdown"
                                onchange="profileManager.handleSharedProfileChange(this.value, 'global')">
                                <option value="">Select a profile...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="header-center">
                    <!-- (global profile selector moved to header-left) -->
                </div>
                <div class="header-right">
                    <button class="btn btn-ghost btn-sm" onclick="app.toggleDarkMode()" id="dark-mode-toggle">
                        <i data-feather="moon"></i>
                        Dark
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="app.showAppInfo()">
                        <i data-feather="help-circle"></i>
                        Help
                    </button>
                    <div class="connection-status connected" id="connection-status" title="Connection Status">
                        <i data-feather="wifi"></i>
                    </div>
                    <div class="secretstore-status" id="secretstore-status" style="display:inline-flex;align-items:center;margin-left:1em;" title="SecretStore Status">
                        <i data-feather="lock" id="secretstore-status-icon"></i>
                    </div>
                </div>
            </div>
        </header>        <!-- Main Content -->
        <div class="app-body">            <!-- Modern Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-section">
                    <nav class="sidebar-nav">
                        <a href="#" class="nav-item active" data-section="profiles" data-tooltip="Profiles">
                            <i data-feather="user"></i>
                            <span>Profiles</span>
                        </a>
                        <a href="#" class="nav-item" data-section="tester" data-tooltip="API Tester">
                            <i data-feather="send"></i>
                            <span>API Tester</span>
                        </a>
                        <a href="#" class="nav-item" data-section="templates" data-tooltip="Templates">
                            <i data-feather="layout"></i>
                            <span>Templates</span>
                        </a>
                        <a href="#" class="nav-item" data-section="history" data-tooltip="History">
                            <i data-feather="clock"></i>
                            <span>History</span>
                        </a>
                    </nav>
                </div>                <div class="sidebar-section">
                    <div class="sidebar-footer">
                        <div class="sidebar-footer-actions">
                            <button class="sidebar-action-btn" onclick="app.exportProfiles()" title="Export Profiles" data-tooltip="Export">
                                <i data-feather="download"></i>
                                <span>Export</span>
                            </button>
                            <button class="sidebar-action-btn" onclick="app.importProfiles()" title="Import Profiles" data-tooltip="Import">
                                <i data-feather="upload"></i>
                                <span>Import</span>
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Panel -->
            <main class="main-panel">                <!-- Profiles Section -->
                <section id="profiles-section" class="content-section active">
                    <div class="section-header">
                        <h2>API Profiles</h2>
                        <div class="section-actions">
                            <button class="btn btn-primary" onclick="profileManager.showCreateModal()">
                                <i data-feather="plus"></i>
                                New Profile
                            </button>
                            <button class="btn btn-outline" onclick="window.profileCreateWizard.show()">
                                <i data-feather="zap"></i>
                                Create Profile (Wizard)
                            </button>
                        </div>
                    </div>

                    <div class="profiles-container">
                        <div id="profile-list" class="profile-list">
                            <!-- Profile list will be rendered here -->
                        </div>
                        
                        <div id="profile-details" class="profile-details card">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i data-feather="user"></i>
                                </div>
                                <h3>No Profile Selected</h3>
                                <p>Select a profile from the list to view its details, or create a new one to get started.</p>
                                <button class="btn btn-primary" onclick="profileManager.showCreateModal()">
                                    <i data-feather="plus"></i>
                                    Create Your First Profile
                                </button>
                            </div>
                        </div>
                    </div>
                </section>                <!-- Endpoint Tester Section -->
                <section id="tester-section" class="content-section">
                    <div class="section-header">
                        <h2>API Endpoint Tester</h2>
                        <div class="section-actions">
                            <!-- Removed shared-profile-selector here, now handled globally -->
                        </div>
                    </div>

                    <div class="tester-container-optimized">
                        <div class="request-builder-compact">
                            <div class="request-builder-header">
                                <div class="method-endpoint-row">
                                    <div class="method-selector-compact">
                                        <button class="method-btn-compact active" data-method="GET" onclick="selectMethod('GET')">GET</button>
                                        <button class="method-btn-compact" data-method="POST" onclick="selectMethod('POST')">POST</button>
                                        <button class="method-btn-compact" data-method="PUT" onclick="selectMethod('PUT')">PUT</button>
                                        <button class="method-btn-compact" data-method="PATCH" onclick="selectMethod('PATCH')">PATCH</button>
                                        <button class="method-btn-compact" data-method="DELETE" onclick="selectMethod('DELETE')">DELETE</button>
                                    </div>
                                    <div class="endpoint-input-group">
                                        <div class="base-url-preview-compact" id="base-url-preview">Select a profile...</div>
                                        <input type="text" id="endpoint-url" class="form-control endpoint-input" placeholder="/endpoint/path" />
                                    </div>
                                </div>
                                <!-- Endpoint validation feedback -->
                                <div id="endpoint-validation-feedback" style="display: none;"></div>
                            </div>

                            <div class="request-builder-body modern-scrollbar">                                <div class="collapsible-section" id="query-params-section">
                                    <div class="collapsible-header" onclick="toggleSection('query-params-section')">
                                        <span>Query Parameters</span>
                                        <i data-feather="chevron-down" class="collapse-icon"></i>
                                    </div>
                                    <div class="collapsible-content">
                                        <div class="collapsible-content-inner">
                                            <div id="query-params" class="key-value-container">
                                                <div class="key-value-pair-compact">
                                                    <input type="text" class="kv-input-compact" placeholder="Parameter Name">
                                                    <input type="text" class="kv-input-compact" placeholder="Parameter Value">
                                                    <button class="kv-remove-btn" onclick="this.closest('.key-value-pair-compact').remove()">×</button>
                                                </div>
                                            </div>
                                            <button class="btn btn-sm btn-outline" onclick="addQueryParam()">
                                                <i data-feather="plus"></i>
                                                Add Parameter
                                            </button>
                                        </div>
                                    </div>
                                </div>                                <div class="collapsible-section" id="headers-section">
                                    <div class="collapsible-header" onclick="toggleSection('headers-section')">
                                        <span>Headers</span>
                                        <i data-feather="chevron-down" class="collapse-icon"></i>
                                    </div>
                                    <div class="collapsible-content">
                                        <div class="collapsible-content-inner">
                                            <div id="request-headers" class="key-value-container">
                                                <div class="key-value-pair-compact">
                                                    <input type="text" class="kv-input-compact" placeholder="Header Name">
                                                    <input type="text" class="kv-input-compact" placeholder="Header Value">
                                                    <button class="kv-remove-btn" onclick="this.closest('.key-value-pair-compact').remove()">×</button>
                                                </div>
                                            </div>
                                            <button class="btn btn-sm btn-outline" onclick="addHeader()">
                                                <i data-feather="plus"></i>
                                                Add Header
                                            </button>
                                        </div>
                                    </div>
                                </div>                                <div class="collapsible-section" id="body-section" style="display: none;">
                                    <div class="collapsible-header" onclick="toggleSection('body-section')">
                                        <span>Request Body</span>
                                        <i data-feather="chevron-down" class="collapse-icon"></i>
                                    </div>
                                    <div class="collapsible-content">
                                        <div class="collapsible-content-inner">
                                            <div class="form-group">
                                                <label>Content Type</label>
                                                <select id="content-type" class="form-control">
                                                    <option value="application/json">application/json</option>
                                                    <option value="application/x-www-form-urlencoded">application/x-www-form-urlencoded</option>
                                                    <option value="text/plain">text/plain</option>
                                                    <option value="application/xml">application/xml</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label>Body Content</label>
                                                <textarea id="request-body" class="form-control" rows="6" placeholder='{"key": "value"}'></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>                                <div class="collapsible-section" id="options-section">
                                    <div class="collapsible-header" onclick="toggleSection('options-section')">
                                        <span>Options</span>
                                        <i data-feather="chevron-down" class="collapse-icon"></i>
                                    </div>
                                    <div class="collapsible-content">
                                        <div class="collapsible-content-inner">
                                            <div class="form-group">
                                                <label class="checkbox-label">
                                                    <input type="checkbox" id="get-all-pages">
                                                    Get All Pages (Pagination)
                                                </label>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label>Page Size</label>
                                                    <input type="number" id="page-size" class="form-control" value="50" min="1" max="100">
                                                </div>
                                                <div class="form-group">
                                                    <label>Max Pages</label>
                                                    <input type="number" id="max-pages" class="form-control" value="10" min="1" max="50">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Send Button -->
                                <button class="btn btn-primary btn-lg send-btn" id="send-btn" onclick="window.endpointTester?.sendRequest()" style="width: 100%;">
                                    <i data-feather="send"></i>
                                    <span>Send Request</span>
                                </button>
                            </div>

                            <!-- Quick Actions Footer -->
                            <div class="request-actions-footer">
                                <button class="quick-action-btn" onclick="window.endpointTester?.generateCode()" title="Generate PowerShell Code">
                                    <i data-feather="code"></i>
                                </button>
                                <button class="quick-action-btn" onclick="window.endpointTester?.clearRequest()" title="Clear Form">
                                    <i data-feather="trash-2"></i>
                                </button>
                                <button class="quick-action-btn" onclick="window.endpointTester?.saveRequest()" title="Save to History">
                                    <i data-feather="save"></i>
                                </button>
                                <button class="quick-action-btn" onclick="app.showSection('history')" title="View History">
                                    <i data-feather="clock"></i>
                                </button>
                            </div>
                        </div>                        <!-- Enhanced Response Viewer -->
                        <div class="response-viewer-optimized">
                            <div class="response-header-enhanced">
                                <div class="response-title">Response Explorer</div>
                                <div class="response-meta-compact" id="response-meta">
                                    <!-- Status will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Search Input -->
                            <div class="response-search-container" id="response-search-container" style="display: none;">
                                <div class="search-input-wrapper">
                                    <i data-feather="search" class="search-icon"></i>
                                    <input type="text" id="response-search-input" class="response-search-input" 
                                           placeholder="Search in response data..." 
                                           onkeydown="if(event.key==='Escape') responseViewer.hideSearch()">
                                    <button class="search-close-btn" onclick="responseViewer.hideSearch()">
                                        <i data-feather="x"></i>
                                    </button>
                                </div>
                                <div class="search-stats" id="search-stats"></div>
                            </div>
                            
                            <!-- Response Tabs -->
                            <div class="response-tabs" id="response-tabs">
                                <!-- Tabs will be dynamically created here -->
                            </div>
                            
                            <div class="response-content-enhanced">
                                <div id="response-viewer" class="response-viewer">
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <i data-feather="radio"></i>
                                        </div>
                                        <h3>Ready to Test</h3>
                                        <p>Send a request to see enhanced response visualization</p>
                                        <div class="empty-features">
                                            <div class="feature-item">
                                                <i data-feather="table"></i>
                                                <span>Table View</span>
                                            </div>
                                            <div class="feature-item">
                                                <i data-feather="git-branch"></i>
                                                <span>Tree Explorer</span>
                                            </div>
                                            <div class="feature-item">
                                                <i data-feather="bar-chart-2"></i>
                                                <span>Data Statistics</span>
                                            </div>
                                            <div class="feature-item">
                                                <i data-feather="file-text"></i>
                                                <span>Schema Analysis</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Templates Section -->
                <section id="templates-section" class="content-section">
                    <div class="section-header">
                        <h2>API Templates</h2>
                        <div class="section-actions">
                            <button class="btn btn-outline" onclick="templateManager.refreshTemplates()">
                                <i data-feather="refresh-cw"></i>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <div class="templates-grid" id="templates-grid">
                        <!-- Templates will be populated here -->
                    </div>
                </section>                <!-- History Section -->
                <section id="history-section" class="content-section">
                    <div class="section-header">
                        <h2>Request History</h2>
                        <div class="section-actions">
                            <div class="history-filter-controls">
                                <!-- Remove profile selector here, now handled globally -->
                                <input type="text" id="history-search" class="form-control" placeholder="Search history..." oninput="window.historyManager.filterHistory(this.value)">
                                <button class="btn btn-outline" onclick="window.historyManager.clear()">
                                    <i data-feather="trash-2"></i>
                                    Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="history-list" id="history-list">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i data-feather="clock"></i>
                            </div>
                            <h3>No History Yet</h3>
                            <p>Your API requests will appear here after you send them.</p>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Profile Create/Edit Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="profile-modal-title">Create New Profile</h3>
                <button class="modal-close" onclick="profileManager.closeModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Profile Name</label>
                            <input type="text" id="profile-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Base URL</label>
                            <input type="url" id="profile-baseurl" class="form-control" placeholder="https://api.example.com" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Authentication Type</label>
                        <select id="profile-authtype" class="form-control" onchange="profileManager.updateAuthFields()">
                            <option value="ApiKey">API Key</option>
                            <option value="BearerToken">Bearer Token</option>
                            <option value="CustomScript">Custom Script</option>
                        </select>
                    </div>

                    <div id="auth-fields-container">
                        <!-- Auth fields will be populated based on type -->
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Pagination Type</label>
                            <select id="profile-pagination" class="form-control">
                                <option value="">Auto-detect</option>
                                <option value="LinkHeader">Link Header</option>
                                <option value="Cursor">Cursor-based</option>
                                <option value="PageBased">Page-based</option>
                                <option value="OffsetLimit">Offset/Limit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="profile-session-only">
                                Session Only (Don't persist to disk)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="profileManager.closeModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="profileManager.saveProfile()">
                    <i data-feather="save"></i>
                    Save Profile
                </button>
            </div>
        </div>
    </div>

    <!-- PowerShell Code Modal -->
    <div id="code-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Generated PowerShell Code</h3>
                <button class="modal-close" onclick="app.closeModal('code-modal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="code-header">
                    <button class="btn btn-outline" onclick="app.copyToClipboard('generated-code')">
                        <i data-feather="copy"></i>
                        Copy to Clipboard
                    </button>
                </div>
                <pre id="generated-code" class="code-block"></pre>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notifications" class="notifications"></div>    <!-- JavaScript -->
    <script src="js/profile-edit-modal.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/secret-manager.js"></script>
    <script src="js/profile-manager.js"></script>
    <script src="js/ui/template-modal.js"></script>
    <script src="js/template-manager.js"></script>    
    <script src="js/core/utils.js"></script>
    <script src="js/core/secure-session.js"></script>
    <script src="js/core/secret-utils.js"></script>
    <script src="js/core/history-manager.js"></script>
    <script src="js/core/endpoint-tester.js"></script>
    <script src="js/app.js"></script>
    <script type="module" src="js/ui/response-ui.js"></script>
    <script type="module" src="js/index.js"></script>
    <script type="module" src="js/profile-create-wizard.js"></script>

    <script>
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Feather icons
            feather.replace({ 
                width: 18, 
                height: 18,
                'stroke-width': 2
            });
        });

        // Global function for collapsible sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const content = section.querySelector('.collapsible-content');
            const icon = section.querySelector('.collapse-icon');
            
            section.classList.toggle('expanded');
            
            if (section.classList.contains('expanded')) {
                content.style.maxHeight = content.scrollHeight + 'px';
                if (icon) icon.style.transform = 'rotate(180deg)';
                localStorage.setItem(`anyapi_${sectionId}_expanded`, 'true');
            } else {
                content.style.maxHeight = '0px';
                if (icon) icon.style.transform = 'rotate(0deg)';
                localStorage.setItem(`anyapi_${sectionId}_expanded`, 'false');
            }
        }

        // Hook up the Manage Secrets button when a profile is selected
        function enableProfileSecretsButton(profileName) {
            const actionDiv = document.getElementById('profile-secrets-action');
            const btn = document.getElementById('manage-profile-secrets-btn');
            if (actionDiv && btn) {
                actionDiv.style.display = 'block';
                btn.onclick = () => secretManager.showProfileSecrets(profileName);
            }
        }
        
        // Replace feather icons whenever DOM updates
        const observer = new MutationObserver(() => {
            feather.replace({ 
                width: 18, 
                height: 18,
                'stroke-width': 2
            });
        });
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // Update global profile selector when profiles are loaded or changed
        function updateGlobalProfileSelector(selectedName) {
            const select = document.getElementById('global-profile-selector');
            if (!select || !window.profileManager) return;
            const profiles = window.profileManager.profiles || [];
            const current = selectedName || window.profileManager.currentSharedProfile?.name || '';
            select.innerHTML = '<option value="">Select a profile...</option>';
            profiles.forEach(profile => {
                if (profile && profile.name) {
                    const opt = document.createElement('option');
                    opt.value = profile.name;
                    opt.textContent = profile.name;
                    select.appendChild(opt);
                }
            });
            if (current && profiles.some(p => p.name === current)) {
                select.value = current;
            }
        }

        // Listen for profile changes and keep selector in sync
        window.addEventListener('profilesLoaded', e => updateGlobalProfileSelector());
        window.addEventListener('profileChanged', e => updateGlobalProfileSelector(e.detail?.profileName));
        window.addEventListener('profileUpdated', e => updateGlobalProfileSelector());

        // On DOMContentLoaded, initialize selector
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => updateGlobalProfileSelector(), 300);
        });

        // Update connection status style (ensure always green glow)
        function setConnectionStatus(connected) {
            const el = document.getElementById('connection-status');
            if (!el) return;
            if (connected) {
                el.classList.add('connected');
                el.classList.remove('disconnected', 'connecting');
                el.innerHTML = '<i data-feather="wifi"></i>';
            } else {
                el.classList.remove('connected');
                el.classList.add('disconnected');
                el.innerHTML = '<i data-feather="wifi-off"></i>';
            }
            feather.replace({ width: 18, height: 18, 'stroke-width': 2 });
        }

        // Listen for secret store status changes and use the centralized function
        window.addEventListener('secretStoreUnlocked', () => {
            if (window.secretManager && typeof window.secretManager.safeUpdateStatusIndicator === 'function') {
                window.secretManager.safeUpdateStatusIndicator();
            }
        });

        window.addEventListener('secretStoreLocked', () => {
            if (window.secretManager && typeof window.secretManager.safeUpdateStatusIndicator === 'function') {
                window.secretManager.safeUpdateStatusIndicator();
            }
        });

        window.addEventListener('secretStoreChecking', () => {
            if (window.secretManager && typeof window.secretManager.safeUpdateStatusIndicator === 'function') {
                window.secretManager.safeUpdateStatusIndicator();
            }
        });

        window.addEventListener('info-updated', () => {
            if (window.secretManager && typeof window.secretManager.safeUpdateStatusIndicator === 'function') {
                window.secretManager.safeUpdateStatusIndicator();
            }
        });

        window.addEventListener('secretStoreInfoUpdated', () => {
            if (window.secretManager && typeof window.secretManager.safeUpdateStatusIndicator === 'function') {
                window.secretManager.safeUpdateStatusIndicator();
            }
        });

        // Listen for connection status changes
        window.addEventListener('connectionStatusChanged', (e) => {
            setConnectionStatus(e.detail?.connected);
            // No notification popup for connected/disconnected
        });

        // On DOMContentLoaded, ensure status is styled
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => setConnectionStatus(true), 100);
        });
    </script>
</body>
</html>